#+TITLE: Dooz-Config

* Me
#+begin_src elisp
(setq user-mail-address "oguz.serbetci@gmail.com"
      user-full-name "Oğuz Şerbetçi")
#+end_src


* FIXES
** MacOS
Use gnu-ls https://stackoverflow.com/questions/25125200/emacs-error-ls-does-not-support-dired.
#+begin_src elisp
(when (string= system-type "darwin")
  (setq dired-use-ls-dired t
        insert-directory-program "/usr/local/bin/gls"
        dired-listing-switches "-aBhl --group-directories-first"))
#+end_src


* Performance
#+begin_src elisp
(add-to-list 'default-frame-alist '(inhibit-double-buffering . t))
(setq display-line-numbers-type nil)
(setq smartparens-global-mode nil)
(setq read-process-output-max (* 8 1024 1024) ; 1mb
      gc-cons-threshold (* 8 1024 1024))
(run-with-idle-timer 2 t (lambda () (garbage-collect)))
#+end_src


* Appearance
Use beautiful title-bar in macOS.
#+begin_src elisp
(add-to-list 'default-frame-alist '(ns-transparent-titlebar . t))
(add-to-list 'default-frame-alist '(ns-appearance . dark))
(setq ns-auto-hide-menu-bar t)
(setq ns-toggle-toolbar nil)
(setq ns-right-alternate-modifier nil)
#+end_src

Pick theme using the macOS settings provided by emacs-plus.
#+begin_src elisp
(defun my/apply-theme (appearance)
  "Load theme, taking current system APPEARANCE into consideration."
  (mapc #'disable-theme custom-enabled-themes)
  (pcase appearance
    ('light (load-theme 'doom-one-light t))
    ('dark (load-theme 'dracula t))))

(doom-themes-org-config)

(add-hook 'ns-system-appearance-change-functions #'my/apply-theme)
#+end_src

For better cooperation with window manager.
#+begin_src elisp
(setq frame-resize-pixelwise t)
#+end_src

Simplify mode-line.
#+begin_src elisp
(setq doom-modeline-buffer-encoding nil
      doom-modeline-percent-position nil)
#+end_src

Add time and battery to modeline.
#+begin_src elisp :tangle no
(display-time-mode 1)
(display-battery-mode 1)
#+end_src

Set fonts, doom-*-font inherits from doom-font.
#+begin_src elisp
(setq doom-font (font-spec :family "Fira Code" :size 12 :weight 'semi-light)
      doom-variable-pitch-font (font-spec :family "Fira Code")
      doom-unicode-font (font-spec :family "Fira Code")
      doom-big-font (font-spec :family "Fira Code" :size 19))
#+end_src


* Editor

Speed up key help.

#+begin_src elisp
(setq which-key-idle-delay 0.5)
#+end_src


#+begin_src elisp
(delete-selection-mode 1)                         ; Replace selection when inserting text
(global-subword-mode 1)                           ; Iterate through CamelCase words

(setq-default
 delete-by-moving-to-trash t                      ; Delete files to trash
 tab-width 4                                      ; Set width for tabs
 uniquify-buffer-name-style 'forward              ; Uniquify buffer names
 ;; window-combination-resize t                      ; take new window space from all other windows (not just current)
 x-stretch-cursor t)                              ; Stretch cursor to the glyph width

(setq undo-limit 80000000                         ; Raise undo-limit to 80Mb
      evil-want-fine-undo t                       ; By default while in insert all changes are one big blob. Be more granular
      auto-save-default t                         ; Nobody likes to loose work, I certainly don't
      inhibit-compacting-font-caches t)           ; When there are lots of glyphs, keep them in memory
#+end_src

LSP mode config.
#+begin_src elisp
(after! lsp
  (setq lsp-response-timeout 30))
#+end_src

** Navigation
Use avy on all windows, e.g. open panels.
#+begin_src elisp
(setq avy-all-windows t)
#+end_src


** Jupyter

#+begin_src elisp :tangle packages.el
(package! jupyter)
#+end_src

#+begin_src elisp
(use-package! jupyter
  :demand t

  :after ob

  :init
  (defun jupyter-run-repl-or-pop-to-buffer-dwim ()
    "If a buffer is already associated with a jupyter buffer,
then pop to it. Otherwise start a jupyter kernel."
    (interactive)
    (if (bound-and-true-p jupyter-current-client)
        (jupyter-repl-pop-to-buffer)
      (call-interactively #'jupyter-run-repl)))

  ;; * eldoc integration
  (defun scimax-jupyter-signature ()
    "Try to return a function signature for the thing at point."
    (when (and (eql major-mode 'org-mode)
               (string= (or (get-text-property (point) 'lang) "") "jupyter-python"))
      (save-window-excursion
     ;;; Essentially copied from (jupyter-inspect-at-point).
        (jupyter-org-with-src-block-client
         (cl-destructuring-bind (code pos)
             (jupyter-code-context 'inspect)
           (jupyter-inspect code pos nil 0)))
        (when (get-buffer "*Help*")
          (with-current-buffer "*Help*"
            (goto-char (point-min))
            (prog1
                (cond
                 ((re-search-forward "Signature:" nil t 1)
                  (buffer-substring (line-beginning-position) (line-end-position)))
                 ((re-search-forward "Docstring:" nil t 1)
                  (forward-line)
                  (buffer-substring (line-beginning-position) (line-end-position)))
                 (t
                  nil))
              ;; get rid of this so we don't accidentally show old results later
              (with-current-buffer "*Help*"
                (toggle-read-only)
                (erase-buffer))))))))
  )
#+end_src

** Python
#+begin_src elisp
(after! poetry
  (setq poetry-tracking-strategy 'projectile)
  )
#+end_src

#+begin_src elisp
(map! :map ein:notebook-mode-map
      :localleader
      "," #'+ein/hydra/body)
#+end_src

Configure Conda to use brew PATH on MacOS.
#+begin_src elisp
(custom-set-variables
 '(conda-anaconda-home "/usr/local/Caskroom/miniconda/base/")
 '(conda-env-autoactivate-mode t)
 )
#+end_src


* Note taking
#+begin_src elisp
(setq ispell-dictionary "en_US")

(after! ivy-bibtex
  ;; (setq ivy-bibtex-default-action 'ivy-bibtex-insert-key)
  (ivy-set-display-transformer 'org-ref-ivy-insert-cite-link
                               'ivy-bibtex-display-transformer)

  (when IS-MAC
    (ivy-bibtex-ivify-action bibtex-completion-quicklook ivy-bibtex-quicklook)
    (ivy-add-actions 'ivy-bibtex '(("SPC" ivy-bibtex-quicklook "Quick look"))))
  )


(remove-hook 'text-mode-hook #'auto-fill-mode)
(add-hook 'message-mode-hook #'word-wrap-mode)


(setq org-directory "~/org/")
(setq deft-directory org-directory)
#+end_src

#+begin_src elisp :tangle packages.el
(package! org-fragtog)
#+end_src

** org-mode
#+begin_src elisp
(after! org
  (setq org-todo-keywords
        '((sequence
           "[ ](T)"    ; A task that needs proper definition, tagging, etc.
           "TODO(t)"   ; A task that needs doing & is ready to do
           "NEXT(n)"   ; A task that is to be started ASAP
           "STRT(s)"   ; A task that is in progress
           "PROJ(p)"   ; An ongoing project that cannot be completed in one step
           "WAIT(w)"   ; Something is holding up this task; or it is paused
           "|"
           "DONE(d)"    ; Task successfully completed
           "KILL(k)"))) ; Task was cancelled, aborted or is no longer applicable

  ;; (add-to-list 'org-latex-classes
  ;;              '("letter"
  ;;                "\\documentclass{letter}[a4paper]
  ;;      \\signature{Oğuz Şerbetçi}
  ;;      \\address{Boxhagener Str. 111 \\\\ Berlin 10245}"
  ;;                ("\\section{%s}" . "\\section*{%s}")
  ;;                ("\\subsection{%s}" . "\\subsection*{%s}")
  ;;                ("\\subsubsection{%s}" . "\\subsubsection*{%s}")))


  (remove-hook 'org-mode-hook #'org-superstar-mode) ;; performance tip
  (setq org-startup-folded t
        org-hide-block-startup t)

  (add-hook 'org-mode-hook 'org-fragtog-mode)

  ;; UI
  ;; (add-hook 'org-mode 'visual-fill-column-mode)
  ;; (setq fill-column 100)

  (defun org-archive-done-in-subtree ()
    (interactive)
    (org-map-entries
     (lambda ()
       (org-archive-subtree)
       (setq org-map-continue-from (org-element-property :begin (org-element-at-point))))
     "/DONE|KILL" 'tree))

  (defun org-archive-done-in-file ()
    (interactive)
    (org-map-entries
     (lambda ()
       (org-archive-subtree)
       (setq org-map-continue-from (org-element-property :begin (org-element-at-point))))
     "/DONE|KILL" 'file))
  (add-to-list 'org-modules 'org-id)
  )
#+end_src

*** Agenda
#+begin_src elisp
(after! org-agenda
  (setq org-stuck-projects
        '("/+PROJ" ("NEXT" "WAIT" "STRT") nil "")
        org-agenda-skip-deadline-prewarning-if-scheduled t)

  (add-to-list 'org-agenda-custom-commands
               '("W" "Weekly Review"
                 ((agenda "" ((org-agenda-span 7))) ; review upcoming deadlines and appointments
                                        ; type "l" in the agenda to review logged items
                  (stuck "") ; review stuck projects as designated by org-stuck-projects
                  (todo "STRT")
                  (todo "NEXT")
                  (todo "WAIT")
                  (todo "PROJ")
                  ))
               )
  (add-to-list 'org-agenda-custom-commands
               '("T" "Daily Planing"
                 ((agenda "" ((org-agenda-span 1))) ; review upcoming deadlines and appointments
                                        ; type "l" in the agenda to review logged items
                  (todo "STRT")
                  (todo "NEXT")
                  (todo "WAIT")
                  ))
               )
  (append
   '(("g" . "GTD contexts")
     ("gw" "@unterwegs" tags-todo "@unterwegs")
     ("gu" "@uni" tags-todo "@uni")
     ("go" "@office" tags-todo "@office")
     ("gh" "@home" tags-todo "@home")
     ("gc" "@computer" tags-todo "@computer")
     ("gp" "@phone" tags-todo "@phone")
     ("G" "GTD Block Agenda"
      ((tags-todo "@unterwegs")
       (tags-todo "@uni")
       (tags-todo "@office")
       (tags-todo "@home")
       (tags-todo "@computer")
       (tags-todo "@phone"))
      nil)) ;; i.e., no local settings
   'org-agenda-custom-commands)
  )
#+end_src


** bibliography

#+begin_src elisp
(setq +latex-viewers '(pdf-tools))
#+end_src

#+begin_src elisp
(setq reftex-default-bibliography '("~/Resources/Papers/Library.bib"
                                    "~/Resources/Papers/ImpactNexus/ImpactNexus.bib"
                                    "~/Resources/Calibre/My Books.bib"))
#+end_src


Configure bibtex-completion.
#+begin_src elisp
(after! bibtex-completion
  ;; (setq bibtex-completion-display-formats '((t . "${=has-pdf=:1}${=has-note=:1} ${author:20} ${year:4} ${title:*} ${=type=:3} ${journaltitle:10}")))

  (add-to-list 'bibtex-completion-additional-search-fields "journaltitle")

  (setq bibtex-completion-bibliography '("~/Resources/Papers/Library.bib"
                                         "~/Resources/Papers/ImpactNexus/ImpactNexus.bib"
                                         "~/Resources/Calibre/My Books.bib")
        bibtex-completion-library-path "~/Resources/Papers/"
        bibtex-completion-notes-path (concat org-directory "roam/bibliography/"))

  ;; (cond
  ;;  (IS-MAC
  ;;   (setq bibtex-completion-pdf-open-function
  ;;         (lambda (fpath)
  ;;           (async-start-process "open" "open" "open" fpath))))
  ;;  (IS-LINUX
  ;;   (setq bibtex-completion-pdf-open-function
  ;;         (lambda (fpath)
  ;;           (async-start-process "open-pdf" "/usr/bin/xdg-open" nil fpath)))))
)
#+end_src

Configure PDF.
#+begin_src elisp
(after! pdf-tools
  (setq pdf-annot-list-highlight-type t)
  (setq-default pdf-view-display-size 'fit-width)

  ;; (push '("f1fa8c" "ffb86c" "#50fa7b" "ff5555" "#8be9fd" "bd93f9" "ff79c6") pdf-annot-color-history)
  ;; https://github.com/politza/pdf-tools/issues/35
  ;; (push '(color . "#000000") pdf-annot-default-markup-annotation-properties)
  )

(after! org-pdftools
  (setq org-pdftools-root-dir "~/Resources/Papers"))
#+end_src

*** org-roam
Install org-roam-bibtex as defined in [[https://github.com/org-roam/org-roam-bibtex#doom-emacs][org-roam/org-roam-bibtex]].
#+begin_src elisp :tangle packages.el
(package! org-roam-bibtex
  :recipe (:host github :repo "org-roam/org-roam-bibtex"))

(unpin! org-roam)

(unpin! bibtex-completion helm-bibtex ivy-bibtex)
#+end_src


Configure org-roam.
#+begin_src elisp
(after! org-roam
  (add-hook! 'org-roam-mode 'org-roam-bibtex-mode)
  (setq org-roam-tag-sources '(prop all-directories))
  )
#+end_src


* Apps
** TODO RSS

Auto update RSS feeds

#+begin_src elisp
(add-hook! 'elfeed-search-mode-hook 'elfeed-update)
#+end_src
